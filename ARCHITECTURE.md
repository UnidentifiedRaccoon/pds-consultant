# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ PDS Consultant Bot

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram –±–æ—Ç–∞-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –ø–æ –ü–î–°.

## üìö –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
- [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
- [–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–∫–ª—é—á–µ–≤—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
- [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π](#–¥–µ—Ç–∞–ª—å–Ω–æ–µ-–æ–ø–∏—Å–∞–Ω–∏–µ-–º–æ–¥—É–ª–µ–π)

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ TypeScript —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ grammY –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏, —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤–µ—Å—å –∫–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ TypeScript —Å strict mode
2. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏ (–±–æ—Ç, —Å–µ—Ä–≤–µ—Ä, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
3. **Webhook-based** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ webhook –≤–º–µ—Å—Ç–æ polling –¥–ª—è production
4. **Stateful conversations** - –ø–æ—Ç–æ–∫–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ –Ω–∞ `@grammyjs/conversations`
5. **Structured logging** - JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Pino

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Core

- **TypeScript 5.9.3** - —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- **Node.js 20.10.0** - runtime environment
- **grammY 1.38.3** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è Telegram –±–æ—Ç–æ–≤

### Web Server

- **Fastify 4.28.1** - HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è webhook
  - –ë—ã—Å—Ç—Ä—ã–π –∏ –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π
  - –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TypeScript

### Utilities

- **Playwright 1.48.0** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF —á–µ—Ä–µ–∑ headless browser
- **Pino 8.17.0** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **dotenv-safe 9.1.0** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **envalid 8.1.0** - –≤–∞–ª–∏–¥–∞—Ü–∏—è env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- **fs-extra 11.2.0** - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### Development

- **tsx** - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ TypeScript –Ω–∞–ø—Ä—è–º—É—é
- **nodemon** - hot reload –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **ESLint + Prettier** - –ª–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Husky + lint-staged** - pre-commit hooks

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
pds-consultant/
‚îú‚îÄ‚îÄ src/                          # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ bot/                      # –ú–æ–¥—É–ª—å –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ attachBotHandlers.ts  # ‚≠ê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conversations/        # ‚≠ê –°—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞ @grammyjs/conversations
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ capitalFlow.ts    #   –î–∏–∞–ª–æ–≥ —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.ts           # ‚≠ê –°–æ–æ–±—â–µ–Ω–∏—è –∏ UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pdfReport.ts          # PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts              # –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –∏ SessionFlavor
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhookBot.ts         # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ + middleware
‚îÇ   ‚îú‚îÄ‚îÄ config/                   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ env.ts                # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ server/                   # HTTP —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fastify.ts            # Fastify + webhook endpoint
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                  # ‚≠ê Entry point
‚îÇ   ‚îî‚îÄ‚îÄ logger.ts                 # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ calculation-models/           # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ capital-lump-sum/         # –ú–æ–¥–µ–ª—å —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª–∞
‚îÇ       ‚îú‚îÄ‚îÄ calculate.ts          # ‚≠ê –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã
‚îÇ       ‚îî‚îÄ‚îÄ index.ts              # –≠–∫—Å–ø–æ—Ä—Ç—ã
‚îú‚îÄ‚îÄ scripts/                      # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ dev-with-localtunnel.ts   # Dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ webhook-manager.ts        # CLI –¥–ª—è webhook
‚îú‚îÄ‚îÄ webhook/                      # Webhook API
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                  # –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è webhook
‚îú‚îÄ‚îÄ dist/                         # –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
‚îú‚îÄ‚îÄ tsconfig.json                 # TypeScript –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ .eslintrc.cjs                 # ESLint –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ package.json                  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã
```

## –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Entry Point (`src/index.ts`)

–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

- –í–∞–ª–∏–¥–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ —Å–µ—Ä–≤–µ—Ä–∞
- –ó–∞–ø—É—Å–∫ HTTP —Å–µ—Ä–≤–µ—Ä–∞
- Graceful shutdown

```typescript
async function startApp(): Promise<void> {
  validateConfig();
  const PORT = platformPort || config.DEV_PORT;
  const bot = createWebhookBot(); // –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞
  const server = createServer(bot); // –°–æ–∑–¥–∞–Ω–∏–µ Fastify —Å–µ—Ä–≤–µ—Ä–∞
  await server.listen({ port: PORT, host: '0.0.0.0' });
  setupShutdownHandlers(server);
}
```

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `validateConfig()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `startApp()` - –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞
- `setupShutdownHandlers()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ SIGINT/SIGTERM –¥–ª—è graceful shutdown

### 2. –ë–æ—Ç (`src/bot/webhookBot.ts`)

–°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä grammY –±–æ—Ç–∞ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:

```typescript
export function createWebhookBot(): Bot<MyContext> {
  const bot = new Bot<MyContext>(config.TELEGRAM_BOT_TOKEN);

  bot.use(session({ initial: () => ({}) }));
  bot.use(conversations());
  bot.use(createConversation(capitalFlow));

  attachBotHandlers(bot);
  return bot;
}
```

### 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (`src/bot/attachBotHandlers.ts`)

**–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ñ–∞–π–ª –±–æ—Ç–∞!** –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞:

```typescript
export function attachBotHandlers(bot: Bot): void {
  // 1. –ö–æ–º–∞–Ω–¥–∞ /start
  bot.command('start', async (ctx: Context) => {
    await handleCommand(chatId, 'start', bot);
  });

  // 2. Inline –∫–Ω–æ–ø–∫–∏ (callback_query)
  bot.on('callback_query:data', async (ctx: Context) => {
    await ctx.answerCallbackQuery();
    await handleCommand(chatId, data, bot);
  });

  // 3. –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  bot.on('message:text', async (ctx: Context) => {
    const conversation = getConversation(chatId);
    if (conversation?.scenario === 'capital') {
      await handleCapitalFlowText(chatId, text, bot, conversation);
    }
  });
}
```

#### –§—É–Ω–∫—Ü–∏—è `handleCommand()`

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥:

```typescript
async function handleCommand(chatId: number, command: string, bot: Bot): Promise<void> {
  switch (command) {
    case 'start':
      await bot.api.sendMessage(chatId, MESSAGES.WELCOME, createMainKeyboard());
      clearConversation(chatId);
      break;

    case 'calculate_capital':
      await bot.api.sendMessage(chatId, MESSAGES.CAPITAL_FLOW.INTRO, ...);
      resetConversation(chatId, { scenario: 'capital', step: 'intro' });
      break;

    case 'capital_gender_male':
    case 'capital_gender_female':
      updateConversation(chatId, {
        step: 'age',
        data: { gender: command === 'capital_gender_male' ? 'male' : 'female' }
      });
      break;
    // ... –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
  }
}
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è "–ö–∞–ø–∏—Ç–∞–ª –∫ –≤—ã–ø–ª–∞—Ç–∞–º"

–ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è:

```typescript
async function handleCapitalFlowText(
  chatId: number,
  text: string,
  bot: Bot,
  conversation: ConversationState
): Promise<void> {
  switch (conversation.step) {
    case 'target_sum':
      const target = Number.parseInt(text, 10);
      if (!Number.isFinite(target) || target < 50000 || target > 100000000) {
        await bot.api.sendMessage(chatId, MESSAGES.CAPITAL_FLOW.ERRORS.INVALID_TARGET_SUM);
        return;
      }
      updateConversation(chatId, { step: 'gender', data: { targetSum: target } });
      await bot.api.sendMessage(chatId, MESSAGES.CAPITAL_FLOW.PROMPTS.GENDER, ...);
      break;

    case 'age':
      // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞
      break;
  }
}
```

#### –†–∞—Å—á–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```typescript
async function sendCapitalCalculationResult(
  chatId: number,
  bot: Bot,
  data: ConversationData | undefined
): Promise<void> {
  const calculation = calculateCapitalLumpSum({
    targetSum: data?.targetSum ?? 0,
    incomeLevel: data?.income ?? 'high',
    ndflRate: ndflRateDecimal,
    reinvest: Boolean(data?.reinvest),
  });

  const message = formatCalculationResult(calculation);
  await bot.api.sendMessage(chatId, message, {
    parse_mode: 'HTML',
    link_preview_options: { is_disabled: true },
    ...createCapitalResultKeyboard(),
  });
}
```

### 4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (`src/bot/conversationState.ts`)

In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤:

```typescript
export interface ConversationData {
  targetSum?: number;
  gender?: 'male' | 'female';
  age?: number;
  income?: 'low' | 'mid' | 'high';
  ndflRate?: string;
  reinvest?: boolean;
}

export interface ConversationState {
  scenario?: 'capital';
  step?: string;
  finished?: boolean;
  data?: ConversationData;
}

const conversations = new Map<number, ConversationState>();

export function getConversation(chatId: number): ConversationState | undefined {
  return conversations.get(chatId);
}

export function updateConversation(
  chatId: number,
  patch: Partial<ConversationState>
): ConversationState {
  const current = conversations.get(chatId) || {};
  const nextData = { ...(current.data || {}), ...(patch.data || {}) };
  const nextState = { ...current, ...patch, data: nextData };
  conversations.set(chatId, nextState);
  return nextState;
}
```

**–í–∞–∂–Ω–æ:** –°–æ—Å—Ç–æ—è–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞. –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è. –î–ª—è production —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis/MongoDB.

### 5. –°–æ–æ–±—â–µ–Ω–∏—è –∏ UI (`src/bot/messages.ts`)

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä:

```typescript
export const MESSAGES = {
  WELCOME: `üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ü–î–°...`,
  INFO_ABOUT_PDS: `‚ú® –ß—Ç–æ —Ç–∞–∫–æ–µ –ü–î–°...`,
  CAPITAL_FLOW: {
    INTRO: `üßÆ –ß—Ç–æ –ø–æ—Å—á–∏—Ç–∞–µ–º...`,
    PROMPTS: {
      TARGET_SUM: `üéØ –¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞...`,
      GENDER: `üë§ –ü–æ–ª...`,
      AGE: `üéÇ –í–æ–∑—Ä–∞—Å—Ç...`,
      // ...
    },
    ERRORS: {
      INVALID_TARGET_SUM: `üòÖ –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å...`,
      // ...
    },
    RESPONSES: {
      RESULT_HEADER: `‚úÖ –°–ø–∞—Å–∏–±–æ! –°—á–∏—Ç–∞—é...`,
      RESULT_BODY: `<b>üìä –°–≤–æ–¥–∫–∞...</b>...`,
      // ...
    },
  },
  BUTTONS: {
    CALCULATE: 'üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å',
    INFO: '‚ÑπÔ∏è –ß—Ç–æ —Ç–∞–∫–æ–µ –ü–î–°?',
    // ...
  },
  CALLBACK_DATA: {
    CALCULATE: 'calculate',
    INFO: 'info',
    // ...
  },
};
```

–§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä:

```typescript
type InlineKeyboardMarkup = {
  inline_keyboard: Array<Array<{ text: string; callback_data: string }>>;
};

export function createMainKeyboard(): { reply_markup: InlineKeyboardMarkup } {
  return {
    reply_markup: {
      inline_keyboard: [
        [
          { text: MESSAGES.BUTTONS.CALCULATE, callback_data: MESSAGES.CALLBACK_DATA.CALCULATE },
          { text: MESSAGES.BUTTONS.INFO, callback_data: MESSAGES.CALLBACK_DATA.INFO },
        ],
      ],
    },
  };
}
```

### 6. HTTP –°–µ—Ä–≤–µ—Ä (`src/server/fastify.ts`)

Fastify —Å–µ—Ä–≤–µ—Ä —Å webhook endpoint –¥–ª—è Telegram:

```typescript
export function createServer(bot: Bot): FastifyInstance {
  const app = Fastify({
    logger: false,
    trustProxy: true, // –î–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ –ø—Ä–æ–∫—Å–∏
  });

  // Health check
  app.get('/health', async () => ({
    ok: true,
    timestamp: new Date().toISOString(),
    service: 'pds-consultant',
  }));

  // Webhook endpoint
  const path = `/tg/${config.WEBHOOK_SECRET}`;
  app.post(path, async (request, reply) => {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
    const secret = request.headers['x-telegram-bot-api-secret-token'];
    if (secret && secret !== config.WEBHOOK_SECRET) {
      return reply.code(401).send({ ok: false, error: 'Unauthorized' });
    }

    // 2. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
    const typedUpdate = request.body as Update;
    if (!typedUpdate.update_id) {
      return reply.code(400).send({ ok: false, error: 'Missing update_id' });
    }

    // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ grammY
    try {
      await bot.handleUpdate(typedUpdate);
      return reply.send({ ok: true });
    } catch (error) {
      logger.error({ err: error, update_id: typedUpdate.update_id }, 'webhook:handler:error');
      return reply.code(500).send({ ok: false, error: 'Internal server error' });
    }
  });

  return app;
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

- Endpoint –∑–∞—â–∏—â–µ–Ω secret token –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `bot.handleUpdate()` –≤–º–µ—Å—Ç–æ `webhookCallback()` –¥–ª—è –ø—Ä—è–º–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ HTTP —Å—Ç–∞—Ç—É—Å—ã

### 7. –ú–æ–¥–µ–ª—å —Ä–∞—Å—á–µ—Ç–æ–≤ (`calculation-models/capital-lump-sum/calculate.ts`)

–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª–∞:

```typescript
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const ANNUAL_RETURN = 0.1; // 10% –≥–æ–¥–æ–≤—ã—Ö
const MONTHLY_RATE = Math.pow(1 + ANNUAL_RETURN, 1 / 12) - 1;
const YEARS = 15;
const STATE_SUPPORT_YEARS = 10;
const STATE_SUPPORT_LIMIT = 36000; // –ú–∞–∫—Å–∏–º—É–º –≤ –≥–æ–¥ –æ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞
const TAX_LIMIT = 400000; // –õ–∏–º–∏—Ç –±–∞–∑—ã –¥–ª—è –≤—ã—á–µ—Ç–∞

// –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≥–æ—Å–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ –¥–æ—Ö–æ–¥—É
const MATCH_BY_INCOME: Record<string, number> = {
  low: 1, // 100% –æ—Ç –≤–∑–Ω–æ—Å–æ–≤ (–¥–æ –ª–∏–º–∏—Ç–∞)
  mid: 0.5, // 50%
  high: 0.25, // 25%
};
```

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

**1. –†–∞—Å—á–µ—Ç –±—É–¥—É—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤:**

```typescript
function futureCapital({
  monthlyContribution,
  matchPct,
  ndflRate,
  reinvest,
}: FutureCapitalParams): number {
  const yearlyContribution = monthlyContribution * 12;
  const support = annualStateSupport(matchPct, yearlyContribution);
  const tax = annualTaxDeduction(ndflRate, yearlyContribution);

  // –ë—É–¥—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ª–∏—á–Ω—ã—Ö –≤–∑–Ω–æ—Å–æ–≤ —Å –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
  const contributionsPart = monthlyContribution * ((BASE_GROWTH - 1) / MONTHLY_RATE);

  // –ë—É–¥—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≥–æ—Å–ø–æ–¥–¥–µ—Ä–∂–∫–∏ (10 –ª–µ—Ç)
  const statePart = support * weight(STATE_SUPPORT_YEARS);

  // –ë—É–¥—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã—á–µ—Ç–∞ (15 –ª–µ—Ç)
  const taxPart = reinvest ? tax * weight(YEARS) : 0;

  return contributionsPart + statePart + taxPart;
}
```

**2. –§—É–Ω–∫—Ü–∏—è –≤–µ—Å–∞ (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ä–æ—Å—Ç–∞):**

```typescript
function weight(years: number): number {
  if (years <= 0) return 0;

  const startPower = Math.pow(YEARLY_FACTOR, YEARS - years);
  const numerator = Math.pow(YEARLY_FACTOR, years) - 1;
  const denominator = YEARLY_FACTOR - 1;

  return startPower * (numerator / denominator);
}
```

**3. –ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –Ω—É–∂–Ω–æ–≥–æ –≤–∑–Ω–æ—Å–∞:**

```typescript
function findMonthlyContribution(
  target: number,
  { matchPct, ndflRate, reinvest }: FindMonthlyContributionParams
): number {
  let low = 0;
  let high = 2_000_000;

  for (let i = 0; i < 80; i += 1) {
    const mid = (low + high) / 2;
    const capital = futureCapital({ monthlyContribution: mid, matchPct, ndflRate, reinvest });

    if (capital >= target) {
      high = mid;
    } else {
      low = mid;
    }

    if (high - low < 0.01) break;
  }

  return high;
}
```

**4. –ì–ª–∞–≤–Ω–∞—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```typescript
export function calculateCapitalLumpSum({
  targetSum,
  incomeLevel,
  ndflRate,
  reinvest,
}: CapitalLumpSumParams): CapitalLumpSumResult {
  if (!Number.isFinite(targetSum) || targetSum <= 0) {
    throw new Error('Target sum is required for calculation');
  }

  const matchPct = MATCH_BY_INCOME[incomeLevel] ?? MATCH_BY_INCOME.high;
  const monthlyContribution = findMonthlyContribution(targetSum, { matchPct, ndflRate, reinvest });

  const yearlyContribution = monthlyContribution * 12;
  const supportYear = annualStateSupport(matchPct, yearlyContribution);
  const taxYear = annualTaxDeduction(ndflRate, yearlyContribution);

  const capital = futureCapital({ monthlyContribution, matchPct, ndflRate, reinvest });

  const personalTotal = yearlyContribution * YEARS;
  const stateTotal = supportYear * STATE_SUPPORT_YEARS;
  const taxTotal = taxYear * YEARS;
  const reinvestedTaxTotal = reinvest ? taxTotal : 0;

  const investmentIncome = capital - (personalTotal + stateTotal + reinvestedTaxTotal);

  const lifePayment = capital / (LIFE_EXPECTANCY_YEARS * 12);
  const tenYearPayment = capital / (10 * 12);

  return {
    capital,
    monthlyContribution,
    personalTotal,
    stateTotal,
    annualStateSupport: supportYear,
    taxYear,
    taxTotal,
    reinvestedTaxTotal,
    investmentIncome,
    lifePayment,
    tenYearPayment,
    lumpSum: capital,
    matchPct,
  };
}
```

### 8. PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (`src/bot/pdfReport.ts`)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Playwright –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML –≤ PDF:

```typescript
export async function generateCapitalPdfReport(
  calculation: CapitalLumpSumResult,
  options?: PdfReportOptions
): Promise<Buffer> {
  const { targetSum, data } = options || {};

  // 1. –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ HTML —à–∞–±–ª–æ–Ω
  const pdfHtml = MESSAGES.CAPITAL_FLOW.RESPONSES.PDF_TEMPLATE.replace(
    '{personalTotal}',
    formatCurrency(calculation.personalTotal)
  ).replace('{monthlyContribution}', formatCurrency(calculation.monthlyContribution));
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–º–µ–Ω—ã
  // 2. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
  await ensureReportsDir();
  const pdfPath = path.join(REPORTS_DIR, `pds-capital-report-${Date.now()}.pdf`);

  // 3. –†–µ–Ω–¥–µ—Ä–∏–º —á–µ—Ä–µ–∑ Playwright
  const browser = await chromium.launch();
  try {
    const page = await browser.newPage();
    await page.setContent(pdfHtml, { waitUntil: 'load' });
    await page.pdf({ path: pdfPath, format: 'A4', printBackground: true });
  } finally {
    await browser.close();
  }

  // 4. –ß–∏—Ç–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
  const buffer = await fs.promises.readFile(pdfPath);
  await fs.promises.unlink(pdfPath);

  return buffer;
}
```

### 9. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`src/config/env.ts`)

–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```typescript
import dotenvSafe from 'dotenv-safe';
import { cleanEnv, num, str } from 'envalid';

// –ó–∞–≥—Ä—É–∂–∞–µ–º .env –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
if (fs.existsSync('.env')) {
  dotenvSafe.config({ example: '.env.example', allowEmptyValues: true });
}

// –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π config
export const config = cleanEnv(process.env, {
  TELEGRAM_BOT_TOKEN: str(),
  DEV_PORT: num({ default: 8080 }),
  WEBHOOK_SECRET: str(),
  PUBLIC_BASE_URL: str({ default: '' }),
});
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- `dotenv-safe` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ `.env.example`
- `envalid` –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–∏–ø—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç defaults
- TypeScript –∑–Ω–∞–µ—Ç —Ç–æ—á–Ω—ã–µ —Ç–∏–ø—ã –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### 10. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (`src/logger.ts`)

–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Pino:

```typescript
export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  base: { svc: 'pds-consultant' }, // –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –ª–æ–≥–∞–º
  timestamp: pino.stdTimeFunctions.isoTime,
});
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```typescript
logger.info({ port: PORT, env: process.env.NODE_ENV }, 'http:listening');
logger.error({ chatId, command, err: error }, 'handleCommand:error');
logger.fatal({ errors }, 'config:validation:failed');
```

–í—ã–≤–æ–¥:

```json
{
  "level": 30,
  "time": "2025-10-17T10:00:00.000Z",
  "svc": "pds-consultant",
  "port": 8080,
  "env": "production",
  "msg": "http:listening"
}
```

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∞–ø–¥–µ–π—Ç–∞

```
Telegram ‚Üí Webhook ‚Üí Fastify ‚Üí grammY Bot ‚Üí Handler ‚Üí Response ‚Üí Telegram
                                     ‚Üì
                              conversationState.ts
                                     ‚Üì
                              calculation-models/
```

**–î–µ—Ç–∞–ª—å–Ω–æ:**

1. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –Ω–∞ `/tg/{WEBHOOK_SECRET}`
2. Fastify –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ `bot.handleUpdate()`
3. grammY –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∞–ø–¥–µ–π—Ç–∞ (command, callback_query, message)
4. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π handler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–ø–¥–µ–π—Ç:
   - –ß–∏—Ç–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ `conversationState`
   - –í—ã–∑—ã–≤–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (—Ä–∞—Å—á–µ—Ç—ã)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ `bot.api.sendMessage()`

### 2. –°—Ü–µ–Ω–∞—Ä–∏–π "–ö–∞–ø–∏—Ç–∞–ª –∫ –≤—ã–ø–ª–∞—Ç–∞–º"

```
/start ‚Üí "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å" ‚Üí "–ö–∞–ø–∏—Ç–∞–ª –∫ –≤—ã–ø–ª–∞—Ç–∞–º" ‚Üí
  –¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞ (text) ‚Üí
  –ü–æ–ª (buttons) ‚Üí
  –í–æ–∑—Ä–∞—Å—Ç (text) ‚Üí
  –î–æ—Ö–æ–¥ (buttons) ‚Üí
  –ù–î–§–õ (buttons) ‚Üí
  –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å? (buttons) ‚Üí
  –†–ê–°–ß–ï–¢ ‚Üí
  –†–µ–∑—É–ª—å—Ç–∞—Ç + PDF
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ:**

```typescript
// –®–∞–≥ 1: intro
{ scenario: 'capital', step: 'intro', data: {} }

// –®–∞–≥ 2: –≤–≤–æ–¥ —Å—É–º–º—ã
{ scenario: 'capital', step: 'target_sum', data: {} }

// –®–∞–≥ 3: –≤—ã–±–æ—Ä –ø–æ–ª–∞
{ scenario: 'capital', step: 'gender', data: { targetSum: 5000000 } }

// –®–∞–≥ 4: –≤–≤–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç–∞
{ scenario: 'capital', step: 'age', data: { targetSum: 5000000, gender: 'male' } }

// ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

// –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
{
  scenario: 'capital',
  step: 'complete',
  finished: true,
  data: {
    targetSum: 5000000,
    gender: 'male',
    age: 35,
    income: 'high',
    ndflRate: '13',
    reinvest: true
  }
}
```

### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF

```
–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞ ‚Üí
  HTML —à–∞–±–ª–æ–Ω —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö ‚Üí
  Playwright (headless Chromium) ‚Üí
  PDF –≤ /tmp ‚Üí
  Buffer ‚Üí
  Telegram sendDocument ‚Üí
  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
```

## TypeScript –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2022", // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π JS
    "module": "NodeNext", // ESM –º–æ–¥—É–ª–∏
    "moduleResolution": "NodeNext", // –ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
    "outDir": "./dist", // –í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
    "strict": true, // –í—Å–µ strict –ø—Ä–æ–≤–µ—Ä–∫–∏
    "esModuleInterop": true, // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å CommonJS
    "skipLibCheck": true, // –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ .d.ts
    "resolveJsonModule": true, // –ò–º–ø–æ—Ä—Ç JSON
    "noUnusedLocals": true, // –û—à–∏–±–∫–∞ –Ω–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    "noUnusedParameters": true, // –û—à–∏–±–∫–∞ –Ω–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    "noImplicitReturns": true, // –í—Å–µ –ø—É—Ç–∏ –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
    "noFallthroughCasesInSwitch": true // –ù–µ—Ç fallthrough –≤ switch
  },
  "include": ["src/**/*", "scripts/**/*", "calculation-models/**/*", "webhook/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### ESLint –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```javascript
module.exports = {
  parser: '@typescript-eslint/parser',
  ignorePatterns: ['dist/', 'node_modules/', '*.d.ts'],
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
    'plugin:import/recommended',
    'plugin:import/typescript',
    'plugin:prettier/recommended',
  ],
  rules: {
    '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],
    '@typescript-eslint/no-explicit-any': 'warn',
  },
};
```

## –°–∫—Ä–∏–ø—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### `scripts/dev-with-localtunnel.ts`

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```typescript
async function main(): Promise<void> {
  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π webhook
  await checkCurrentWebhook();

  // 2. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä —Å nodemon (hot reload)
  startServer(); // nodemon src/index.ts

  // 3. –ó–∞–ø—É—Å–∫–∞–µ–º localtunnel —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
  setTimeout(startTunnel, 2000);

  // 4. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ URL –æ—Ç localtunnel - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook
  // handleTunnelOutput() -> setWebhook()
}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

1. –ó–∞–ø—É—Å–∫–∞–µ—Ç TypeScript —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ `tsx` + `nodemon`
2. –°–æ–∑–¥–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å —á–µ—Ä–µ–∑ `localtunnel`
3. –ü–∞—Ä—Å–∏—Ç URL —Ç—É–Ω–Ω–µ–ª—è –∏–∑ –≤—ã–≤–æ–¥–∞
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook –Ω–∞ —ç—Ç–æ—Ç URL
5. –ü—Ä–∏ Ctrl+C –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

### `scripts/webhook-manager.ts`

CLI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è webhook:

```typescript
async function main(): Promise<number> {
  switch (command) {
    case 'set':
      await setWebhook(webhookUrl);
      break;
    case 'info':
      const info = await getWebhookInfo();
      console.log('Webhook Info:', info);
      break;
    case 'delete':
      await deleteWebhook();
      break;
  }
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. Webhook –∑–∞—â–∏—Ç–∞

- **Secret token** –≤ URL: `/tg/{WEBHOOK_SECRET}`
- **Secret token –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ**: `x-telegram-bot-api-secret-token`
- –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–µ–≤–æ–π —Å—É–º–º—ã
if (!Number.isFinite(target) || target < 50000 || target > 100000000) {
  await bot.api.sendMessage(chatId, MESSAGES.CAPITAL_FLOW.ERRORS.INVALID_TARGET_SUM);
  return;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞
if (!Number.isFinite(age) || age < 18 || age > 100) {
  await bot.api.sendMessage(chatId, MESSAGES.CAPITAL_FLOW.ERRORS.INVALID_AGE);
  return;
}
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ try-catch:

```typescript
try {
  await handleCommand(chatId, 'start', bot);
} catch (error) {
  logger.error({ err: error, chatId }, 'command:error');
  await bot.api.sendMessage(chatId, MESSAGES.ERRORS.GENERIC, createMainKeyboard());
}
```

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏** - —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
2. **–û–¥–∏–Ω–æ—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å** - –Ω–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
3. **PDF –≤ /tmp** - –º–æ–∂–µ—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∏—Å–∫

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production

1. **Redis –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π:**

```typescript
import Redis from 'ioredis';
const redis = new Redis(process.env.REDIS_URL);

export async function getConversation(chatId: number) {
  const data = await redis.get(`conversation:${chatId}`);
  return data ? JSON.parse(data) : undefined;
}
```

2. **–ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤:**

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PM2 –∏–ª–∏ Kubernetes
- –û–±—â–∏–π Redis –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
- Load balancer –ø–µ—Ä–µ–¥ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏

3. **S3 –¥–ª—è PDF:**

```typescript
const s3Url = await uploadToS3(pdfBuffer);
await bot.api.sendDocument(chatId, new InputFile(s3Url));
```

4. **Rate limiting:**

```typescript
import rateLimit from '@fastify/rate-limit';
app.register(rateLimit, {
  max: 100,
  timeWindow: '1 minute',
});
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# Development
LOG_LEVEL=debug npm run dev

# Production
LOG_LEVEL=info npm start

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
LOG_LEVEL=error npm start
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤

```typescript
// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ
logger.info({ port, env }, 'http:listening');

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
logger.warn({ signal }, 'shutdown:start');

// –û—à–∏–±–∫–∏
logger.error({ err, chatId }, 'handleCommand:error');

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ
logger.fatal({ errors }, 'config:validation:failed');
```

### –û—Ç–ª–∞–¥–∫–∞ webhook

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
npm run webhook:info

# –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - —É–¥–∞–ª–∏—Ç—å –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
npm run webhook:delete
npm run dev  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –Ω–æ–≤—ã–π
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö:

- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (TypeScript strict mode)
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å (—á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤)
- ‚úÖ –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫)
- ‚úÖ –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å (–ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ)
- ‚úÖ –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)

–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ production —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∞–º–∏ (Redis, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –º–µ—Ç—Ä–∏–∫–∏).
